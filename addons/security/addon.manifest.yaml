# SPDX-FileCopyrightText: Â© 2024 Siemens Healthineers AG
#
# SPDX-License-Identifier: MIT

apiVersion: v1
kind: AddonManifest
metadata:
  name: security
  description: 'Enables secure communication into and inside the cluster'
spec:
  implementations:
    - name: security
      description: 'Enables secure communication into and inside the cluster'
      offline_usage:
        linux:
          repos: []
          deb: []
          curl: []
          additionalImages:
            - registry.k8s.io/external-dns/external-dns
            - cr.l5d.io/linkerd/policy-controller:edge-25.4.4
            - cr.l5d.io/linkerd/controller:edge-25.4.4
            - shsk2s.azurecr.io/linkerd/proxy:edge-25.4.4
            - shsk2s.azurecr.io/linkerd/proxy-init:v2.4.2
          additionalImagesFiles:
            - ../common/manifests/external-dns/deployment.yaml  
        windows:
          additionalImages:
            - shsk2s.azurecr.io/linkerd/proxy:edge-25.4.4
            - shsk2s.azurecr.io/linkerd/proxy-init:v2.4.2
          curl:
            - url: https://github.com/cert-manager/cmctl/releases/download/v2.0.0/cmctl_windows_amd64.exe
              destination: bin\cmctl.exe
          linkerd:
            - url: https://github.com/linkerd/linkerd2/releases/download/edge-25.4.4/linkerd2-cli-edge-25.4.4-windows.exe
              destination: bin\linkerd.exe
      commands:
        enable:
          cli:
            flags:
              - name: ingress
                shorthand: i
                default: nginx
                description: Ingress controller to use for exposing security
                constraints:
                  kind: validation-set
                  validationSet:
                    - nginx
                    - traefik
              - name: type
                shorthand: t
                default: basic
                description: Type of security (basic->trust level cluster, enhanced->zero trust)
                constraints:
                  kind: validation-set
                  validationSet:
                    - basic
                    - enhanced
              - name: omitHydra
                description: Omit hydra and login implementation
                type: boolean
                default: false
              - name: omitKeycloak
                description: Omit keycloak and use external oauth2 provider
                type: boolean
                default: false
              - name: omitOAuth2Proxy
                description: Omit OAuth2 proxy deployment
                type: boolean
                default: false
            examples:
              - cmd: k2s addons enable security
                comment: Enable security addon with CA issuer configured
              - cmd: k2s addons enable security --type enhanced
                comment: Enable security addon with zero trust settings
              - cmd: k2s addons enable security --omitHydra
                comment: Enable security addon and omit hydra/login setup
              - cmd: k2s addons enable security --omitKeycloak
                comment: Enable security addon and omit keycloak setup
              - cmd: k2s addons enable security --omitHydra --omitKeycloak
                comment: Enable security addon and omit both hydra/login and keycloak setup
              - cmd: k2s addons enable security --omitOAuth2Proxy
                comment: Enable security addon and omit OAuth2 proxy setup
              - cmd: k2s addons enable security --omitHydra --omitKeycloak --omitOAuth2Proxy
                comment: Enable security addon and omit hydra/login, keycloak, and OAuth2 proxy setup
          script:
            subPath: Enable.ps1
            parameterMappings:
              - cliFlagName: ingress
                scriptParameterName: Ingress
              - cliFlagName: type
                scriptParameterName: Type
              - cliFlagName: omitHydra
                scriptParameterName: OmitHydra
              - cliFlagName: omitKeycloak
                scriptParameterName: OmitKeycloak
              - cliFlagName: omitOAuth2Proxy
                scriptParameterName: OmitOAuth2Proxy
        disable:
          cli:
            examples:
              - cmd: k2s addons disable security
                comment: Disable addon security in K2s
          script:
            subPath: Disable.ps1
