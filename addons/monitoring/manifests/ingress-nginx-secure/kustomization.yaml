# SPDX-FileCopyrightText: Â© 2023 Siemens Healthcare GmbH
#
# SPDX-License-Identifier: MIT

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../ingress-nginx

# ~1 in a patch's path means "/" as part of the key name
# Example:
# "/metadata/annotations/nginx.ingress.kubernetes.io~1auth-url" means:
# metadata:
#   annotations:
#     nginx.ingress.kubernetes.io/auth-url:
patches:
- patch: |-
    - op: replace
      path: "/data/plutono.ini"
      value: |-
        [analytics]
        check_for_updates = true
        [grafana_net]
        url = https://grafana.net
        [log]
        mode = console
        # [log.console]
        # level=debug
        [paths]
        data = /var/lib/plutono/
        logs = /var/log/plutono
        plugins = /var/lib/plutono/plugins
        provisioning = /etc/plutono/provisioning
        [server]
        # these settings needed to make it work with Ingress
        root_url = https://k2s.cluster.local/monitoring
        serve_from_sub_path = true
        domain = k2s.cluster.local
        protocol = https
        cert_key = /cert/tls.key
        cert_file = /cert/tls.crt
        [auth]
        oauth_auto_login: true
        signout_redirect_url: "https://k2s.cluster.local/oauth2/sign_out"
        [auth.proxy]
        enabled: true
        header_name: X-Email
        header_property: email
        auto_sign_up: true
        [users]
        allow_sign_up: false
        auto_assign_org: true
        auto_assign_org_role: Viewer
  target:
    kind: ConfigMap
    name: kube-prometheus-stack-plutono
    namespace: monitoring

- patch: |-
    $patch: delete
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: kube-prometheus-stack-plutono
      namespace: monitoring
      labels:
        helm.sh/chart: grafana-6.57.4
        app.kubernetes.io/name: kube-prometheus-stack-plutono
        app.kubernetes.io/instance: kube-prometheus-stack
        app.kubernetes.io/version: "9.5.5"
        app.kubernetes.io/managed-by: Helm
    data:
      plutono.ini: |
        [analytics]
        check_for_updates = true
        [grafana_net]
        url = https://grafana.net
        [log]
        mode = console
        [paths]
        data = /var/lib/plutono/
        logs = /var/log/plutono
        plugins = /var/lib/plutono/plugins
        provisioning = /etc/plutono/provisioning
        [server]
        # these settings needed to make it work with Ingress
        root_url = https://k2s.cluster.local/monitoring
        serve_from_sub_path = true
        domain = k2s.cluster.local
        protocol = https
        cert_key = /cert/tls.key
        cert_file = /cert/tls.crt
