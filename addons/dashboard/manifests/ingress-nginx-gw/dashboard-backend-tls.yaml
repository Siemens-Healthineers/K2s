# SPDX-FileCopyrightText: © 2024 Siemens Healthineers AG
#
# SPDX-License-Identifier: MIT

# BackendTLSPolicy configures TLS settings for backend connections
# This enables NGINX Gateway Fabric to use HTTPS when connecting to kong-proxy:443
#
# Certificate Validation Strategy:
# - Without security addon: kong uses self-signed cert (CN=localhost)
#   → Enable.ps1 extracts the certificate and creates kong-ca-cert ConfigMap
#   → This policy references that ConfigMap for validation
# - With security addon (cert-manager): kong may use cert-manager issued cert
# Current configuration: Uses extracted kong certificate (works for both scenarios)
apiVersion: gateway.networking.k8s.io/v1
kind: BackendTLSPolicy
metadata:
  name: dashboard-backend-tls
  namespace: dashboard
spec:
  targetRefs:
  - group: ""
    kind: Service
    name: kubernetes-dashboard-kong-proxy # ← Tells NGF: use HTTPS for this Service
  validation:
    # Use caCertificateRefs for self-signed certificates
    # The kong-ca-cert ConfigMap is created by dashboard/Enable.ps1
    caCertificateRefs:
    - name: kong-ca-cert
      group: ""
      kind: ConfigMap
    # Hostname must match the certificate CN (localhost for kong default cert)
    hostname: localhost
