# SPDX-FileCopyrightText: Â© 2025 Siemens Healthineers AG
# SPDX-License-Identifier: MIT

name: Automerge from Dependabot PR

on:
  workflow_dispatch:
#  pull_request_target:
#    types: [opened, synchronize]
#permissions:
#  pull-requests: write
#  contents: write

jobs:
  dependabot-pr:
    timeout-minutes: 30
    continue-on-error: false
    runs-on: windows-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Golang
        uses: actions/setup-go@v5
        with:
          go-version: ${{env.GOVERSION}}
          cache-dependency-path: "**/*.sum"
          
      - name: Show all diff
        run: |
          git diff --exit-code -- .
  
      - name: Configure repo
        run: |
          git config --local user.email github-actions@github.com
          git config --local user.name github-actions
          git remote -v
  
      - name: Current working directory
        run: |
          ls
  
      - name: Run go mod tidy
        run: |
          cd k2s
          go mod tidy
          cd ..
  
      - name: Build all k2s executables
        run: |
          .\smallsetup\common\BuildGoExe.ps1 -BuildAll
          ls

      - name: Run Unit Tests
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          .\test\execute_all_tests.ps1 -Tags unit -V -ThrowOnFailure
        
      - name: Run ci Acceptance Tests
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          .\test\execute_all_tests.ps1 -Tags ci -ExcludeTags unit, integration -V -ThrowOnFailure

      # Approve and merge if tests succeed
      - uses: dependabot/fetch-metadata@v2.4.0
        id: metadata
        with:
          github-token: ${{ secrets.AUTOCOMMIT_TOKEN }}
          
      - name: Approve PR
        run: gh pr review --approve "${{ github.event.pull_request.html_url }}"
        env:
          GH_TOKEN: ${{ secrets.AUTOCOMMIT_TOKEN }}
          
      - name: Merge PR
        run: gh pr merge "${{ github.event.pull_request.html_url }}" --auto --squash
        env:
          GH_TOKEN: ${{ secrets.AUTOCOMMIT_TOKEN }}
  
