# .github/workflows/delete-old-branches.yml

name: Delete old branches

# This workflow is scheduled to run every Sunday at midnight.
# You can customize the cron schedule to your needs.
# For more information on cron syntax, see https://crontab.guru/
on:
  schedule:
    - cron: '0 0 * * 0'
  # You can also run this workflow manually from the Actions tab.
  workflow_dispatch:

jobs:
  delete_old_branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to delete branches
      # This action also requires the pull-requests permission to check if a branch
      # has an open PR.
      pull-requests: write

    steps:
      - name: Delete branches older than 6 months
        # Using a different action that supports regex for branch protection
        uses: fpicalausa/remove-stale-branches@v2.0.0
        with:
          # Your GitHub token is required to interact with the repository.
          # The default GITHUB_TOKEN has the necessary permissions.
          github-token: ${{ secrets.DELETE_BRANCHES_TOKEN }}
          
          # The number of days a branch must be stale before it's considered for deletion.
          # 6 months is approximately 180 days.
          days-before-branch-stale: 180

          # This action requires a second input for the days to wait after a branch is
          # marked as stale before it is deleted. Setting this to 0 means it will
          # be deleted immediately after being marked as stale.
          days-before-branch-delete: 0

          # A regular expression defining branch names that are exempt from cleanup.
          # This protects 'main', 'master', and any branch starting with 'release-1.2.'.
          exempt-branches-regex: '^(main|master|release-*)$'

          # A dry run will only log which branches would be deleted without
          # actually deleting them. This is highly recommended for the first few runs.
          # Change this to 'false' to enable actual deletion.
          dry-run: true
