# SPDX-FileCopyrightText: Â© 2023 Siemens Healthcare GmbH
#
# SPDX-License-Identifier: MIT

# Build k2s Pipeline
# Responsible for trigerring build for k2s executable when the source is changed.

name: "Build - k2s CLI"

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - 'pkg/base/**'
      - 'pkg/k2s/**'

env:
  GOVERSION: "1.21.5"


jobs:
  build-k2s-cli:
    name: Build k2s CLI
    timeout-minutes: 30
    continue-on-error: false
    runs-on: ubuntu-latest
    env:
      CI_COMMIT_MESSAGE: Auto-commit k2s cli
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Golang
      uses: actions/setup-go@v4
      with:
        go-version: ${{env.GOVERSION}}
        cache-dependency-path: "**/*.sum"

    - name: Show all diff
      run: |
        git diff --exit-code -- .

    - name: Configure repo
      run: |
        git config --local user.email github-actions@github.com
        git config --local user.name github-actions

    - name: Current working directory
      run: |
        pwsh -Command ls

    - name: Build k2s executable
      run: |
        pwsh ./smallsetup/common/BuildGoExe.ps1
        pwsh -Command ls

    - name: Commit k2s cli
      run: |
        git add k2s.exe
        git commit -m "${{ env.CI_COMMIT_MESSAGE }}"
        git push
  run-acceptance-tests:
    name: Run Acceptance Tests
    needs: build-k2s-cli
    timeout-minutes: 30
    continue-on-error: false
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{env.GOVERSION}}
        cache-dependency-path: "**/*.sum"

    - name: Show all diff
      run: |
        git diff --exit-code -- .

    - name: Show Source Files
      shell: pwsh
      run: ls -r

    - name: Run no-setup Acceptance Tests
      shell: powershell
      run: |
        $ErrorActionPreference = "Continue"
        .\test\execute_all_tests.ps1 -Tags no-setup -ExcludeTags unit,integration -V -ThrowOnFailure