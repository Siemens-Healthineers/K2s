# SPDX-FileCopyrightText: Â© 2023 Siemens Healthcare GmbH
#
# SPDX-License-Identifier: MIT
# CI Pipeline

variables:
  GOBIN: '$(GOROOT)\bin' # Go binaries path
  GOVERSION: "1.21.5"

trigger:
  batch: true
  branches:
    include:
      - main
  paths:
    include:
      - addons
      - pkg
      - smallsetup
      - test
      - cfg
    exclude:
      - k2s.exe
      - bin/*
      - doc
      - LICENSES

jobs:
  - job: RunUnitTests
    displayName: "Run Unit Tests"
    pool:
      vmImage: "windows-latest"
    cancelTimeoutInMinutes: 5
    timeoutInMinutes: 30
    continueOnError: false
    workspace:
      clean: all
    steps:
      - task: GoTool@0
        inputs:
          version: "$(GOVERSION)"
        displayName: "Select Go Version"

      - pwsh: |
          go install github.com/onsi/ginkgo/v2/ginkgo@v2.13.2
          $env:Path
          ls $(GOBIN)
          (Get-Command -ErrorAction Ignore -Type Application ginkgo)
        displayName: Install test deps

      - pwsh: |
          ls -r
        displayName: Source Files

      - powershell: |
          .\test\execute_all_tests.ps1 -Tags unit -V -ThrowOnFailure
        displayName: Run Unit Tests
        errorActionPreference: Continue
