# SPDX-FileCopyrightText: Â© 2023 Siemens Healthcare GmbH
#
# SPDX-License-Identifier: MIT

# Builds all K2s executables
# Responsible for trigerring build for all K2s executables [bridge.exe, cloudinitisobuilder.exe, devgon.exe, httpproxy.exe, k2s.exe, vfprules.exe, zap.exe]

variables:
  GOVERSION: "1.21.5"

trigger: none

pool:
  vmImage: ubuntu-latest

steps:
  - task: GoTool@0
    inputs:
      version: "$(GOVERSION)"
    displayName: "Select Go Version"

  - checkout: self
    displayName: Checkout k2sSetup
    clean: true
    persistCredentials: true

  - script: |
      git fetch --all
      git switch $(basename $(Build.SourceBranch))
      git config --local user.email $BUILD_REQUESTEDFOREMAIL
      git config --local user.name "$BUILD_REQUESTEDFOR"
    displayName: Configure Repo

  - script: |
      pwsh -Command ls
    displayName: Current Working Directory

  - script: |
      pwsh ./smallsetup/common/BuildGoExe.ps1 -BuildAll:true
    displayName: Build GO Executables

  - script: |
      git status
      git add k2s.exe bin/cloudinitisobuilder.exe bin/devgon.exe bin/httpproxy.exe bin/zap.exe bin/yaml2json.exe bin/cni/bridge.exe bin/cni/vfprules.exe
      git commit -m "Built GO Executables"
      git push
    displayName: Commit GO Executables
